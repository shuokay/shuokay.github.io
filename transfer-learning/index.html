<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shuokay.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Transfer learning 通常在训练数据不足的情况下使用. 所谓 transfer learning 最直观的理解是给模型一个很好初始值. 由于使用的 base model 通常都是在各大 benchmark 上取得 state of the art 效果的模型, 因此, transfer learning 通常能带来事半功倍的效果. 另外, transfer learning 还可以防">
<meta property="og:type" content="article">
<meta property="og:title" content="MXNet Transfer Learning">
<meta property="og:url" content="http://shuokay.com/transfer-learning/index.html">
<meta property="og:site_name" content="Memo">
<meta property="og:description" content="Transfer learning 通常在训练数据不足的情况下使用. 所谓 transfer learning 最直观的理解是给模型一个很好初始值. 由于使用的 base model 通常都是在各大 benchmark 上取得 state of the art 效果的模型, 因此, transfer learning 通常能带来事半功倍的效果. 另外, transfer learning 还可以防">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://shuokay.com/content/images/bot/dirstatus.png">
<meta property="og:image" content="http://shuokay.com/content/images/bot/datadir.png">
<meta property="article:published_time" content="2016-09-02T04:43:10.000Z">
<meta property="article:modified_time" content="2022-08-13T02:16:25.735Z">
<meta property="article:author" content="yushu.gao">
<meta property="article:tag" content="Deep Learning">
<meta property="article:tag" content="CNN">
<meta property="article:tag" content="MXNet">
<meta property="article:tag" content="Transfer Learning">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://shuokay.com/content/images/bot/dirstatus.png">

<link rel="canonical" href="http://shuokay.com/transfer-learning/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MXNet Transfer Learning | Memo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Memo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://shuokay.com/transfer-learning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yushu.gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Memo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MXNet Transfer Learning
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-02 12:43:10" itemprop="dateCreated datePublished" datetime="2016-09-02T12:43:10+08:00">2016-09-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CNN/" itemprop="url" rel="index"><span itemprop="name">CNN</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Transfer learning 通常在训练数据不足的情况下使用. 所谓 transfer learning 最直观的理解是给模型一个很好初始值. 由于使用的 base model 通常都是在各大 benchmark 上取得 state of the art 效果的模型, 因此, transfer learning 通常能带来事半功倍的效果. 另外, transfer learning 还可以防止网络过早出现过拟合. 当然, 使用 transfer learning 的基础是两个数据集的数据分布是相似的. 本文使用 BOT 2016 计算机视觉大赛的数据, 详细记录了 transfer learning 的过程.</p>
<span id="more"></span>

<h1 id="准备数据"><a href="#准备数据" class="headerlink" title="准备数据"></a>准备数据</h1><p>下载&#x2F;解压数据就不再赘述了. 下面是我的工作目录的状态</p>
<center><img src="/content/images/bot/dirstatus.png" width="600"></center>
其中, `data` 目录结构如下
<center><img src="/content/images/bot/datadir.png" width="600"></center>

<h2 id="生成-MXNet-的-rec-格式的数据"><a href="#生成-MXNet-的-rec-格式的数据" class="headerlink" title="生成 MXNet 的 rec 格式的数据"></a>生成 MXNet 的 rec 格式的数据</h2><p>分为两个步骤, 首先是生成一个 list 文件, 该文件没一行有 3 各字段 <code>label, index, path</code>, 分别对应了路径为 <code>path</code> 的图片的 <code>label</code> 和 <code>index</code>. 第二步是使用上面生成的 list 文件, 来生成训练过程中真正使用的 <code>rec</code> 文件.</p>
<h3 id="步骤一-生成-list-文件"><a href="#步骤一-生成-list-文件" class="headerlink" title="步骤一: 生成 list 文件"></a>步骤一: 生成 list 文件</h3><p>暂时不能使用 gif 格式的图片, 所以, 我没有处理 gif 格式的图片.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --list=true 是说明我们要生成list</span></span><br><span class="line"><span class="comment"># --train-ratio=0.8 我们把 80% 的数据用来作为训练数据, 剩下的 20% 自动作为 validation</span></span><br><span class="line"><span class="comment"># --recursive=true 迭代地去找图片</span></span><br><span class="line"><span class="comment"># bot 生成的 list 文件的前缀</span></span><br><span class="line"><span class="comment"># data/ 我们存放的图片数据的根目录</span></span><br><span class="line">python path/to/mxnet/tools/im2rec.py --list=<span class="literal">true</span> --train-ratio=0.8 --exts=[<span class="string">&#x27;.jpg&#x27;</span>,<span class="string">&#x27;.jpeg&#x27;</span>,<span class="string">&#x27;.png&#x27;</span>] --recursive=<span class="literal">true</span> bot data/</span><br></pre></td></tr></table></figure>

<p>这个步骤完成之后, 会生成 3 个 list 文件, 分别是:</p>
<ol>
<li><code>bot_train.lst</code>, 存放了训练数据的信息, 顺序已经打乱</li>
<li><code>bot_val.lst</code>, 存放了 validation 数据, 顺序没有打乱</li>
<li><code>bot_test.lst</code>, 存放 test 数据, 因为在生成 list 的时候我们没有指定要把多少比例的数据作为 test 数据, 默认为 0, 所以, 这个文件是空的.</li>
</ol>
<h3 id="步骤二-生成-rec-文件"><a href="#步骤二-生成-rec-文件" class="headerlink" title="步骤二: 生成 rec 文件"></a>步骤二: 生成 rec 文件</h3><p>最终输入到 MXNet 中的数据是 <code>rec</code> 格式, 我们需要利用步骤一得到的 list 文件, 生成 <code>rec</code> 文件.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --resize=224, 把图片较短的边 resize 到 224, 不同的配置 resize 的方法不同, 具体内容请参考源码</span></span><br><span class="line"><span class="comment"># bot_val.lst, 步骤一中生生成的 list 文件</span></span><br><span class="line"><span class="comment"># data/ 图片存放的根目录, 使用 bot_val.lst 中每一行的地址拼上 data/ 就可以准确定位到一张图片</span></span><br><span class="line">python path/to/mxnet/tools/im2rec.py --resize=224 --quality=100 bot_val.lst data/</span><br></pre></td></tr></table></figure>

<p>这个步骤之后, 我们得到了 2 个 <code>rec</code> 文件, 分别是:</p>
<ol>
<li><code>bot_train.rec</code>, 训练数据</li>
<li><code>bot_val.rec</code>, validation 数据.</li>
</ol>
<p><code>im2rec.py</code> 还有很多其它的选项配置, 这里没有用到,所以就不一一解释了.</p>
<h1 id="转换模型参数和网络结构信息"><a href="#转换模型参数和网络结构信息" class="headerlink" title="转换模型参数和网络结构信息"></a>转换模型参数和网络结构信息</h1><p>首先要说明, MXNet 提供的用于转换 <code>caffe</code> 网络结构的脚本有一点小错误, 首先我们要修改一下脚本.<br>打开 <code>path/to/mxnet/tools/caffe_converter/convert_symbol.py</code> 文件, 修改一下 188 行.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># symbol_string, output_name = <span class="built_in">proto2script</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">symbol_string, output_name, input_dim = <span class="built_in">proto2script</span>(sys.argv[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p>你也可以打印出来 <code>input_dim</code> 的值, 这个值是 <code>(10, 3, 224, 224)</code></p>
<h2 id="步骤一-转换网络结构"><a href="#步骤一-转换网络结构" class="headerlink" title="步骤一: 转换网络结构"></a>步骤一: 转换网络结构</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 caffe 格式的 deploy 文件</span></span><br><span class="line">wget -c https://gist.githubusercontent.com/ksimonyan/211839e770f7b538e2d8/raw/c3ba00e272d9f48594acef1f67e5fd12aff7a806/VGG_ILSVRC_16_layers_deploy.prototxt</span><br><span class="line"><span class="comment"># 转换</span></span><br><span class="line"><span class="comment"># VGG_ILSVRC_16_layers_deploy.prototxt 上面下载的文件</span></span><br><span class="line"><span class="comment"># vgg16.py 转换结果的存储位置</span></span><br><span class="line">python convert_symbol.py VGG_ILSVRC_16_layers_deploy.prototxt vgg16.py</span><br></pre></td></tr></table></figure>

<p>完成之后, 生成 <code>vgg16.py</code> 文件, 就是我们需要的结果<br>下面是我的转换结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">conv1_1 = mx.symbol.Convolution(name=<span class="string">&#x27;conv1_1&#x27;</span>, data=data , num_filter=<span class="number">64</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu1_1 = mx.symbol.Activation(name=<span class="string">&#x27;relu1_1&#x27;</span>, data=conv1_1 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">conv1_2 = mx.symbol.Convolution(name=<span class="string">&#x27;conv1_2&#x27;</span>, data=relu1_1 , num_filter=<span class="number">64</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu1_2 = mx.symbol.Activation(name=<span class="string">&#x27;relu1_2&#x27;</span>, data=conv1_2 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">pool1 = mx.symbol.Pooling(name=<span class="string">&#x27;pool1&#x27;</span>, data=relu1_2 , pad=(<span class="number">0</span>,<span class="number">0</span>), kernel=(<span class="number">2</span>,<span class="number">2</span>), stride=(<span class="number">2</span>,<span class="number">2</span>), pool_type=<span class="string">&#x27;max&#x27;</span>)</span><br><span class="line">conv2_1 = mx.symbol.Convolution(name=<span class="string">&#x27;conv2_1&#x27;</span>, data=pool1 , num_filter=<span class="number">128</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu2_1 = mx.symbol.Activation(name=<span class="string">&#x27;relu2_1&#x27;</span>, data=conv2_1 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">conv2_2 = mx.symbol.Convolution(name=<span class="string">&#x27;conv2_2&#x27;</span>, data=relu2_1 , num_filter=<span class="number">128</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu2_2 = mx.symbol.Activation(name=<span class="string">&#x27;relu2_2&#x27;</span>, data=conv2_2 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">pool2 = mx.symbol.Pooling(name=<span class="string">&#x27;pool2&#x27;</span>, data=relu2_2 , pad=(<span class="number">0</span>,<span class="number">0</span>), kernel=(<span class="number">2</span>,<span class="number">2</span>), stride=(<span class="number">2</span>,<span class="number">2</span>), pool_type=<span class="string">&#x27;max&#x27;</span>)</span><br><span class="line">conv3_1 = mx.symbol.Convolution(name=<span class="string">&#x27;conv3_1&#x27;</span>, data=pool2 , num_filter=<span class="number">256</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu3_1 = mx.symbol.Activation(name=<span class="string">&#x27;relu3_1&#x27;</span>, data=conv3_1 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">conv3_2 = mx.symbol.Convolution(name=<span class="string">&#x27;conv3_2&#x27;</span>, data=relu3_1 , num_filter=<span class="number">256</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu3_2 = mx.symbol.Activation(name=<span class="string">&#x27;relu3_2&#x27;</span>, data=conv3_2 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">conv3_3 = mx.symbol.Convolution(name=<span class="string">&#x27;conv3_3&#x27;</span>, data=relu3_2 , num_filter=<span class="number">256</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu3_3 = mx.symbol.Activation(name=<span class="string">&#x27;relu3_3&#x27;</span>, data=conv3_3 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">pool3 = mx.symbol.Pooling(name=<span class="string">&#x27;pool3&#x27;</span>, data=relu3_3 , pad=(<span class="number">0</span>,<span class="number">0</span>), kernel=(<span class="number">2</span>,<span class="number">2</span>), stride=(<span class="number">2</span>,<span class="number">2</span>), pool_type=<span class="string">&#x27;max&#x27;</span>)</span><br><span class="line">conv4_1 = mx.symbol.Convolution(name=<span class="string">&#x27;conv4_1&#x27;</span>, data=pool3 , num_filter=<span class="number">512</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu4_1 = mx.symbol.Activation(name=<span class="string">&#x27;relu4_1&#x27;</span>, data=conv4_1 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">conv4_2 = mx.symbol.Convolution(name=<span class="string">&#x27;conv4_2&#x27;</span>, data=relu4_1 , num_filter=<span class="number">512</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu4_2 = mx.symbol.Activation(name=<span class="string">&#x27;relu4_2&#x27;</span>, data=conv4_2 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">conv4_3 = mx.symbol.Convolution(name=<span class="string">&#x27;conv4_3&#x27;</span>, data=relu4_2 , num_filter=<span class="number">512</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu4_3 = mx.symbol.Activation(name=<span class="string">&#x27;relu4_3&#x27;</span>, data=conv4_3 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">pool4 = mx.symbol.Pooling(name=<span class="string">&#x27;pool4&#x27;</span>, data=relu4_3 , pad=(<span class="number">0</span>,<span class="number">0</span>), kernel=(<span class="number">2</span>,<span class="number">2</span>), stride=(<span class="number">2</span>,<span class="number">2</span>), pool_type=<span class="string">&#x27;max&#x27;</span>)</span><br><span class="line">conv5_1 = mx.symbol.Convolution(name=<span class="string">&#x27;conv5_1&#x27;</span>, data=pool4 , num_filter=<span class="number">512</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu5_1 = mx.symbol.Activation(name=<span class="string">&#x27;relu5_1&#x27;</span>, data=conv5_1 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">conv5_2 = mx.symbol.Convolution(name=<span class="string">&#x27;conv5_2&#x27;</span>, data=relu5_1 , num_filter=<span class="number">512</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu5_2 = mx.symbol.Activation(name=<span class="string">&#x27;relu5_2&#x27;</span>, data=conv5_2 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">conv5_3 = mx.symbol.Convolution(name=<span class="string">&#x27;conv5_3&#x27;</span>, data=relu5_2 , num_filter=<span class="number">512</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>)</span><br><span class="line">relu5_3 = mx.symbol.Activation(name=<span class="string">&#x27;relu5_3&#x27;</span>, data=conv5_3 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">pool5 = mx.symbol.Pooling(name=<span class="string">&#x27;pool5&#x27;</span>, data=relu5_3 , pad=(<span class="number">0</span>,<span class="number">0</span>), kernel=(<span class="number">2</span>,<span class="number">2</span>), stride=(<span class="number">2</span>,<span class="number">2</span>), pool_type=<span class="string">&#x27;max&#x27;</span>)</span><br><span class="line">flatten_0=mx.symbol.Flatten(name=<span class="string">&#x27;flatten_0&#x27;</span>, data=pool5)</span><br><span class="line">fc6 = mx.symbol.FullyConnected(name=<span class="string">&#x27;fc6&#x27;</span>, data=flatten_0 , num_hidden=<span class="number">4096</span>, no_bias=<span class="literal">False</span>)</span><br><span class="line">relu6 = mx.symbol.Activation(name=<span class="string">&#x27;relu6&#x27;</span>, data=fc6 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">drop6 = mx.symbol.Dropout(name=<span class="string">&#x27;drop6&#x27;</span>, data=relu6 , p=<span class="number">0.500000</span>)</span><br><span class="line">fc7 = mx.symbol.FullyConnected(name=<span class="string">&#x27;fc7&#x27;</span>, data=drop6 , num_hidden=<span class="number">4096</span>, no_bias=<span class="literal">False</span>)</span><br><span class="line">relu7 = mx.symbol.Activation(name=<span class="string">&#x27;relu7&#x27;</span>, data=fc7 , act_type=<span class="string">&#x27;relu&#x27;</span>)</span><br><span class="line">drop7 = mx.symbol.Dropout(name=<span class="string">&#x27;drop7&#x27;</span>, data=relu7 , p=<span class="number">0.500000</span>)</span><br><span class="line">fc8 = mx.symbol.FullyConnected(name=<span class="string">&#x27;fc8&#x27;</span>, data=drop7 , num_hidden=<span class="number">1000</span>, no_bias=<span class="literal">False</span>)</span><br><span class="line">prob = mx.symbol.SoftmaxOutput(name=<span class="string">&#x27;prob&#x27;</span>, data=fc8 )</span><br></pre></td></tr></table></figure>

<h2 id="步骤二-转换参数"><a href="#步骤二-转换参数" class="headerlink" title="步骤二: 转换参数"></a>步骤二: 转换参数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 caffe 格式的模型参数 caffemodel</span></span><br><span class="line">wget -c http://www.robots.ox.ac.uk/~vgg/software/very_deep/caffe/VGG_ILSVRC_16_layers.caffemodel</span><br><span class="line"><span class="comment"># 转换格式</span></span><br><span class="line"><span class="comment"># VGG_ILSVRC_16_layers_deploy.prototxt 步骤一下载的 caffe 的 deploy 文件</span></span><br><span class="line"><span class="comment"># VGG_ILSVRC_16_layers.caffemodel 上面下载的 caffemodel 文件</span></span><br><span class="line"><span class="comment"># 这一步骤时间比较久, 需要 3~5min</span></span><br><span class="line">python convert_model.py VGG_ILSVRC_16_layers_deploy.prototxt VGG_ILSVRC_16_layers.caffemodel vgg16</span><br></pre></td></tr></table></figure>

<p>完成之后生成两个文件:</p>
<ol>
<li><code>vgg16-symbol.json</code>, 定义了网络图结构</li>
<li><code>vgg16-0001.params</code>, 对应的参数, 约 528M</li>
</ol>
<h1 id="构建网络"><a href="#构建网络" class="headerlink" title="构建网络"></a>构建网络</h1><p>现在万事俱备, 我们开始构建自己的用于 transfer learning 的网络. 首先是把 vgg16.py 略做修改.</p>
<p>修改最后两行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fc8 = mx.symbol.FullyConnected(name=&#x27;fc8&#x27;, data=drop7 , num_hidden=1000, no_bias=False)</span></span><br><span class="line"><span class="comment"># prob = mx.symbol.SoftmaxOutput(name=&#x27;prob&#x27;, data=fc8 )</span></span><br><span class="line">fc8 = mx.symbol.FullyConnected(name=<span class="string">&#x27;myfc8&#x27;</span>, data=drop7 , num_hidden=<span class="number">12</span>, no_bias=<span class="literal">False</span>) <span class="comment"># 因为 bot 比赛只有 12 类, 我们修改相应的类别数</span></span><br><span class="line">prob = mx.symbol.SoftmaxOutput(name=<span class="string">&#x27;softmax&#x27;</span>, data=fc8 ) <span class="comment"># mxnet 默认是 softmax_label, 所以, 这里把 prob 修改成 softmax</span></span><br></pre></td></tr></table></figure>

<p>在最开始的部分加入输入 <code>variable</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data=mx.symbol.Variable(<span class="string">&quot;data&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>修改相应层的 <code>lr_mult</code> 参数, 该参数的意义是该层的参数更新的 learn rate 需要在基础的base learn rate 上乘以该参数, 即 <code>lr=lr_base*lr_mult</code>, 例如:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conv1_1 = mx.symbol.Convolution(name=<span class="string">&#x27;conv1_1&#x27;</span>, data=data , num_filter=<span class="number">64</span>, pad=(<span class="number">1</span>,<span class="number">1</span>), kernel=(<span class="number">3</span>,<span class="number">3</span>), stride=(<span class="number">1</span>,<span class="number">1</span>), no_bias=<span class="literal">False</span>, attr=&#123;<span class="string">&#x27;lr_mult&#x27;</span>:<span class="string">&#x27;0.01&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="加载数据"><a href="#加载数据" class="headerlink" title="加载数据"></a>加载数据</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_iterator</span>(<span class="params">batch_size=<span class="number">128</span></span>):</span><br><span class="line">    data_shape=(<span class="number">3</span>, <span class="number">224</span>, <span class="number">224</span>)</span><br><span class="line">    data_iter=<span class="string">&quot;./&quot;</span></span><br><span class="line">    train=mx.io.ImageRecordIter(</span><br><span class="line">        path_imgrec  = data_iter+<span class="string">&quot;bot_train.rec&quot;</span>,</span><br><span class="line">        <span class="comment"># &quot;mean.bin&quot; 并不存在, 这里 MXNet 发现不存在的话会自动生成</span></span><br><span class="line">        mean_img     = data_iter+<span class="string">&quot;mean.bin&quot;</span>,</span><br><span class="line">        data_shape   = data_shape,</span><br><span class="line">        batch_size   = batch_size,</span><br><span class="line">        rand_crop    = <span class="literal">True</span>,</span><br><span class="line">        rand_mirror  = <span class="literal">True</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    val=mx.io.ImageRecordIter(</span><br><span class="line">        path_imgrec  = data_iter+<span class="string">&quot;bot_val.rec&quot;</span>,</span><br><span class="line">        mean_img     = data_iter+<span class="string">&quot;mean.bin&quot;</span>,</span><br><span class="line">        data_shape   = data_shape,</span><br><span class="line">        batch_size   = batch_size,</span><br><span class="line">        rand_crop    = <span class="literal">False</span>,</span><br><span class="line">        rand_mirror  = <span class="literal">False</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> (train, val)</span><br></pre></td></tr></table></figure>

<h1 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 logging, 不然不会打印输出</span></span><br><span class="line">head = <span class="string">&#x27;%(asctime)-15s %(message)s&#x27;</span></span><br><span class="line">logging.basicConfig(level=logging.DEBUG, <span class="built_in">format</span>=head)</span><br><span class="line">batch_size=<span class="number">32</span></span><br><span class="line"><span class="comment"># 如果有 2 块显卡, 可以使用 dev=[mx.gpu(0), mx.gpu(1)], 其它类推</span></span><br><span class="line">dev=[mx.gpu(<span class="number">0</span>)]</span><br><span class="line"><span class="comment"># 载入我们转换好的模型.</span></span><br><span class="line">old_model = mx.model.FeedForward.load(<span class="string">&quot;vgg16&quot;</span>, <span class="number">1</span>)</span><br><span class="line">model= mx.model.FeedForward(ctx=dev,</span><br><span class="line">                            symbol=get_symbol(),</span><br><span class="line">                            num_epoch=<span class="number">200</span>,</span><br><span class="line">                            learning_rate=<span class="number">0.01</span>,</span><br><span class="line">                            wd=<span class="number">0.0001</span>,</span><br><span class="line">                            arg_params=old_model.arg_params,</span><br><span class="line">                            aux_params=old_model.aux_params,</span><br><span class="line">                            allow_extra_params=<span class="literal">True</span></span><br><span class="line">                            )</span><br><span class="line">data_train, data_test=get_iterator(batch_size)</span><br><span class="line">model.fit(X=data_train,</span><br><span class="line">          eval_data=data_test,</span><br><span class="line">          kvstore=<span class="string">&#x27;local_allreduce_device&#x27;</span>,</span><br><span class="line">          batch_end_callback=mx.callback.Speedometer(batch_size, <span class="number">50</span>),</span><br><span class="line">          epoch_end_callback=mx.callback.do_checkpoint(<span class="string">&quot;bot&quot;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>因为是图像识别任务, 所以, 整个过程还是中规中矩, 比较简答. 通过这种方法, 在没有调整训练参数的情况下, 跑了 2 个 epoch, validation 准确率能达到 92.6%. 效果还可以.<br>完整代码请参考 <a target="_blank" rel="noopener" href="https://github.com/shuokay/bot_competition">github</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Deep-Learning/" rel="tag"># Deep Learning</a>
              <a href="/tags/CNN/" rel="tag"># CNN</a>
              <a href="/tags/MXNet/" rel="tag"># MXNet</a>
              <a href="/tags/Transfer-Learning/" rel="tag"># Transfer Learning</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/mxnet-io/" rel="prev" title="MXNet IO 接口使用方法">
      <i class="fa fa-chevron-left"></i> MXNet IO 接口使用方法
    </a></div>
      <div class="post-nav-item">
    <a href="/gradient-descent/" rel="next" title="梯度下降和 BP 算法">
      梯度下降和 BP 算法 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE"><span class="nav-number">1.</span> <span class="nav-text">准备数据</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90-MXNet-%E7%9A%84-rec-%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="nav-number">1.1.</span> <span class="nav-text">生成 MXNet 的 rec 格式的数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%80-%E7%94%9F%E6%88%90-list-%E6%96%87%E4%BB%B6"><span class="nav-number">1.1.1.</span> <span class="nav-text">步骤一: 生成 list 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C-%E7%94%9F%E6%88%90-rec-%E6%96%87%E4%BB%B6"><span class="nav-number">1.1.2.</span> <span class="nav-text">步骤二: 生成 rec 文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BD%AC%E6%8D%A2%E6%A8%A1%E5%9E%8B%E5%8F%82%E6%95%B0%E5%92%8C%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%84%E4%BF%A1%E6%81%AF"><span class="nav-number">2.</span> <span class="nav-text">转换模型参数和网络结构信息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%B8%80-%E8%BD%AC%E6%8D%A2%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%84"><span class="nav-number">2.1.</span> <span class="nav-text">步骤一: 转换网络结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A5%E9%AA%A4%E4%BA%8C-%E8%BD%AC%E6%8D%A2%E5%8F%82%E6%95%B0"><span class="nav-number">2.2.</span> <span class="nav-text">步骤二: 转换参数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E7%BD%91%E7%BB%9C"><span class="nav-number">3.</span> <span class="nav-text">构建网络</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE"><span class="nav-number">4.</span> <span class="nav-text">加载数据</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%AD%E7%BB%83"><span class="nav-number">5.</span> <span class="nav-text">训练</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%93%E8%AF%AD"><span class="nav-number">6.</span> <span class="nav-text">结语</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">yushu.gao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">92</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yushu.gao</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
